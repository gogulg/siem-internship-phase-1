/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */(()=>{var e={976:(e,t,r)=>{"use strict";r.r(t),r.d(t,{httpResponseIntoObservable:()=>g,plugin:()=>v});var o=r(915);let n=function(e){return e.User="user",e.Assistant="assistant",e.Tool="tool",e}({});const s=__kbnSharedDeps__.Rxjs;let i=function(e){return e.ChatCompletionChunk="chatCompletionChunk",e.ChatCompletionTokenCount="chatCompletionTokenCount",e.ChatCompletionMessage="chatCompletionMessage",e}({}),a=function(e){return e.OutputUpdate="output",e.OutputComplete="complete",e}({}),l=function(e){return e.error="error",e}({}),c=function(e){return e.internalError="internalError",e.requestError="requestError",e.abortedError="requestAborted",e}({});class errors_InferenceTaskError extends Error{constructor(e,t,r){super(t),this.code=e,this.meta=r}toJSON(){return{type:l.error,error:{code:this.code,message:this.message,meta:this.meta}}}}function u(e="An internal error occurred",t){return new errors_InferenceTaskError(c.internalError,e,null!=t?t:{})}let p=function(e){return e.TokenLimitReachedError="tokenLimitReachedError",e.ToolNotFoundError="toolNotFoundError",e.ToolValidationError="toolValidationError",e}({});function d(e){return e.role!==n.Assistant}var f=Object.defineProperty,h=(e,t,r)=>((e,t,r)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r)(e,"symbol"!=typeof t?t+"":t,r);class ParseError extends Error{constructor(e,t){super(e),h(this,"type"),h(this,"field"),h(this,"value"),h(this,"line"),this.name="ParseError",this.type=t.type,this.field=t.field,this.value=t.value,this.line=t.line}}function m(e){}function g(){return(0,s.pipe)((0,s.switchMap)((e=>function(e){const t=e.response,r=null==t?void 0:t.body;return r?new s.Observable((e=>{const t=function(e){const{onEvent:t=m,onError:r=m,onRetry:o=m,onComment:n}=e;let s,i="",a=!0,l="",c="";function u(e){if(""===e)return l.length>0&&t({id:s,event:c||void 0,data:l.endsWith("\n")?l.slice(0,-1):l}),s=void 0,l="",void(c="");if(e.startsWith(":"))return void(n&&n(e.slice(e.startsWith(": ")?2:1)));const r=e.indexOf(":");if(-1===r)p(e,"",e);else{const t=e.slice(0,r),o=" "===e[r+1]?2:1;p(t,e.slice(r+o),e)}}function p(e,t,n){switch(e){case"event":c=t;break;case"data":l=`${l}${t}\n`;break;case"id":s=t.includes("\0")?void 0:t;break;case"retry":/^\d+$/.test(t)?o(parseInt(t,10)):r(new ParseError(`Invalid \`retry\` value: "${t}"`,{type:"invalid-retry",value:t,line:n}));break;default:r(new ParseError(`Unknown field "${e.length>20?`${e.slice(0,20)}â€¦`:e}"`,{type:"unknown-field",field:e,value:t,line:n}))}}return{feed:function(e){const t=a?e.replace(/^\xEF\xBB\xBF/,""):e,[r,o]=function(e){const t=[];let r="";const o=e.length;for(let n=0;n<o;n++){const o=e[n];"\r"===o&&"\n"===e[n+1]?(t.push(r),r="",n++):"\r"===o||"\n"===o?(t.push(r),r=""):r+=o}return[t,r]}(`${i}${t}`);for(const e of r)u(e);i=o,a=!1},reset:function(e={}){i&&e.consume&&u(i),s=void 0,l="",c="",i=""}}}({onEvent:t=>{e.next(t.data)}});(async()=>{const e=r.getReader(),o=new TextDecoder,n=({done:r,value:s})=>r?Promise.resolve():(t.feed(o.decode(s,{stream:!0})),e.read().then(n));return e.read().then(n)})().then((()=>{e.complete()})).catch((t=>{e.error(t)}))})):(0,s.throwError)((()=>{throw u("No readable stream found in response")}))}(e))),(0,s.catchError)((e=>(0,s.throwError)((()=>u(e.message))))),(0,s.map)((e=>{try{return JSON.parse(e)}catch(e){throw u("Failed to parse JSON")}})),(0,s.tap)((e=>{if(e.type===l.error){const t=e;throw new errors_InferenceTaskError(t.error.code,t.error.message,t.error.meta)}})))}class InferencePlugin{constructor(e){(0,o.default)(this,"logger",void 0),this.logger=e.logger.get()}setup(e,t){return{}}start(e,t){const r=function({http:e}){return({connectorId:t,messages:r,system:o,toolChoice:n,tools:i,temperature:a,modelName:l,functionCalling:c,stream:u})=>{const p={connectorId:t,system:o,messages:r,toolChoice:n,tools:i,temperature:a,modelName:l,functionCalling:c};return u?(0,s.from)(e.post("/internal/inference/chat_complete/stream",{asResponse:!0,rawResponse:!0,body:JSON.stringify(p)})).pipe(g()):e.post("/internal/inference/chat_complete",{body:JSON.stringify(p)})}}({http:e.http});return{chatComplete:r,output:(o=r,function e({id:t,connectorId:r,input:l,schema:c,system:u,previousMessages:f,modelName:h,functionCalling:m,stream:g,abortSignal:v,metadata:y,retry:b}){if(g&&void 0!==b)throw new Error("Retry options are not supported in streaming mode");const C=function(e){const t=[];return e.forEach((e=>{const r=t[t.length-1];r&&d(r)===d(e)&&t.push({content:"-",role:d(e)?n.Assistant:n.User}),t.push(e)})),t}([...f||[],{role:n.User,content:l}]),E=o({connectorId:r,stream:g,modelName:h,functionCalling:m,abortSignal:v,metadata:y,system:u,messages:C,...c?{tools:{structuredOutput:{description:"Use the following schema to respond to the user's request in structured data, so it can be parsed and handled.",schema:c}},toolChoice:{function:"structuredOutput"}}:{}});return(0,s.isObservable)(E)?E.pipe((0,s.filter)((e=>e.type!==i.ChatCompletionTokenCount)),(0,s.map)((e=>e.type===i.ChatCompletionChunk?{type:a.OutputUpdate,id:t,content:e.content}:{id:t,output:e.toolCalls.length&&"arguments"in e.toolCalls[0].function?e.toolCalls[0].function.arguments:void 0,content:e.content,type:a.OutputComplete}))):E.then((e=>({id:t,content:e.content,output:e.toolCalls.length&&"arguments"in e.toolCalls[0].function?e.toolCalls[0].function.arguments:void 0})),(o=>{if(function(e){return e instanceof errors_InferenceTaskError&&e.code===p.ToolValidationError}(o)&&null!=b&&b.onValidationError){var s,i;const a="number"==typeof b.onValidationError?b.onValidationError:1;return e({id:t,connectorId:r,input:l,schema:c,system:u,abortSignal:v,previousMessages:C.concat({role:n.Assistant,content:"",toolCalls:o.meta.toolCalls},...null!==(s=null===(i=o.meta.toolCalls)||void 0===i?void 0:i.map((e=>({name:e.function.name,role:n.Tool,toolCallId:e.toolCallId,response:{error:o.meta}}))))&&void 0!==s?s:[]),functionCalling:m,modelName:h,stream:!1,retry:{onValidationError:a-1}})}throw o}))}),getConnectors:async()=>(await e.http.get("/internal/inference/connectors")).connectors};var o}}const v=e=>new InferencePlugin(e)},352:(e,t,r)=>{r.p=window.__kbnPublicPath__.inference},915:(e,t,r)=>{e.exports=r(497)(67493)},497:e=>{"use strict";e.exports=__kbnSharedDeps_npm__}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var s=t[o]={exports:{}};return e[o](s,s.exports,r),s.exports}r.d=(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var o=t.getElementsByTagName("script");if(o.length)for(var n=o.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=o[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),r(352),__kbnBundles__.define("plugin/inference/public",r,976)})();